import asyncio
import sys
from pathlib import Path

# Add project root to path
BASE_DIR = Path(__file__).resolve().parent.parent
if str(BASE_DIR) not in sys.path:
    sys.path.insert(0, str(BASE_DIR))

from database import get_connection
from utils.config_manager import config_manager

MESSAGES = {
    # User
    "welcome_back": "–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {name}! üëã\n\n–í–∞—à–∏—Ö —á–µ–∫–æ–≤: {count}{days_text}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ üëá",
    "welcome_new": "üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {promo_name}!\n\n–ü—Ä–∏–∑—ã: {prizes}\n\n–î–ª—è —É—á–∞—Å—Ç–∏—è –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:",
    "profile": "üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å\n\n–ò–º—è: {name}\n–¢–µ–ª–µ—Ñ–æ–Ω: {phone}\n\nüìä –ß–µ–∫–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: {total}\n–ß–µ–∫–æ–≤ –ø—Ä–∏–Ω—è—Ç–æ: {valid}{wins_text}{days_text}",
    "help": "ü§ñ –ß—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç:\n\nüßæ –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫ ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ QR-–∫–æ–¥\nüë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\nüìã –ú–æ–∏ —á–µ–∫–∏ ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∑–æ–∫\n‚ÑπÔ∏è FAQ ‚Äî —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\nüÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî —Å–≤—è–∑—å —Å –Ω–∞–º–∏\n\n–ö–æ–º–∞–Ω–¥—ã: /start /help /status /cancel",
    "status": "üìä {name}\n\n–ß–µ–∫–æ–≤: {valid}\n–î–æ –∫–æ–Ω—Ü–∞: {days} –¥–Ω.",
    "no_receipts": "üìã –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–µ–∫–æ–≤\n\n–ù–∞–∂–º–∏—Ç–µ ¬´üßæ –ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫¬ª",
    "receipts_list": "üìã –í–∞—à–∏ —á–µ–∫–∏ ({total})\n",
    
    # Receipts
    "promo_ended": "üèÅ –ê–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ {date}\n\n–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ!",
    "upload_instruction": "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ QR-–∫–æ–¥–∞ —Å —á–µ–∫–∞\n\n–í–∞—à–∏—Ö —á–µ–∫–æ–≤: {count}\n\nüí° QR-–∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á—ë—Ç–∫–∏–º –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –∫–∞–¥—Ä–µ",
    "scanning": "‚è≥ –°–∫–∞–Ω–∏—Ä—É—é QR... (3 —Å–µ–∫)",
    "file_too_big": "‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 5MB.",
    "processing_error": "‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑",
    "check_failed": "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.",
    "scan_failed": "üîç –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —á–µ–∫\n\n‚Ä¢ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –±–ª–∏–∂–µ\n‚Ä¢ –£–ª—É—á—à–∏—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ\n\nüí° –°–≤–µ–∂–∏–π —á–µ–∫? –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 –º–∏–Ω—É—Ç",
    "fns_wait": "üßæ –ß–µ–∫ –Ω–∞–π–¥–µ–Ω –≤ –§–ù–°, –Ω–æ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑ —á–∞—Å.",
    "rate_limit": "‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ",
    "service_unavailable": "‚ö†Ô∏è –°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    "receipt_no_product": "üòî –í —á–µ–∫–µ –Ω–µ—Ç –∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤",
    "receipt_duplicate": "‚ÑπÔ∏è –≠—Ç–æ—Ç —á–µ–∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω",
    "receipt_save_error": "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ–∫",
    "receipt_first": "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –ø–µ—Ä–≤—ã–º —á–µ–∫–æ–º!\n\n–í—ã –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ! –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –µ—â—ë üéØ",
    "receipt_valid": "‚úÖ –ß–µ–∫ –ø—Ä–∏–Ω—è—Ç!\n\n–í—Å–µ–≥–æ —á–µ–∫–æ–≤: {count} üéØ",
    "upload_qr_prompt": "üì∑ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é QR-–∫–æ–¥–∞",
    
    # Registration
    "reg_cancel": "–•–æ—Ä–æ—à–æ! –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å üëã",
    "reg_name_error": "–í–≤–µ–¥–∏—Ç–µ –∏–º—è (2-100 —Å–∏–º–≤–æ–ª–æ–≤)",
    "reg_phone_prompt": "–û—Ç–ª–∏—á–Ω–æ, {name}! üëã\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:",
    "reg_phone_error": "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–∞–∫ +79991234567",
    "reg_phone_request": "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
    "reg_success": "‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n1. –ö—É–ø–∏—Ç–µ –∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã\n2. –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥\n3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å—é–¥–∞\n\n–ê–∫—Ü–∏—è: {start} ‚Äî {end}\n\nüëá –ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π —á–µ–∫",
    
    # Admin
    "stats_msg": "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n\nüë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: {users}\n   —Å–µ–≥–æ–¥–Ω—è: +{users_today}\n\nüßæ –ß–µ–∫–∏: {receipts}\n   –ø—Ä–∏–Ω—è—Ç–æ: {valid}\n   —Å–µ–≥–æ–¥–Ω—è: +{receipts_today}\n\nüéØ –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {participants}\nüìà –ö–æ–Ω–≤–µ—Ä—Å–∏—è: {conversion}%\n\nüèÜ –ü–æ–±–µ–¥–∏—Ç–µ–ª–µ–π: {winners}"
}

async def migrate():
    print("üöÄ Starting text migration...")
    
    # Initialize DB pool
    from database import init_db
    await init_db()
    
    count = 0
    for key, text in MESSAGES.items():
        existing = config_manager.get_message(key)
        if not existing:
            await config_manager.set_message(key, text)
            print(f"‚úÖ Added: {key}")
            count += 1
        else:
            print(f"‚è≠Ô∏è Skipped (exists): {key}")
            
    print(f"\n‚ú® Migration complete! Added {count} new messages.")

if __name__ == "__main__":
    asyncio.run(migrate())
